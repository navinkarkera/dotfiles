#!/usr/bin/env sh

set -f
PUEUE_TASKS="pueue status --group=${PUEUE_GROUP:-'default'} --json | jq -c '.tasks' | jq -r '.[] | \"\(.id | tostring | (\" \" * (2 - length)) + .) | \(.group) | \(.path[-25:]) | \(.status) | \(.command[-55:])\"'"
header="p:pause | s:start | r:restart | q:kill | l:log | f:reload | e:edit log in nvim | t: tail log"

bind="\
ctrl-p:execute-silent(echo {} | cut -d'|' -f1 | xargs pueue pause > /dev/null)+reload^$PUEUE_TASKS^,\
ctrl-s:execute-silent(echo {} | cut -d'|' -f1 | xargs pueue start > /dev/null)+reload^$PUEUE_TASKS^,\
ctrl-r:execute-silent(echo {} | cut -d'|' -f1 | xargs pueue restart -ik > /dev/null)+reload^$PUEUE_TASKS^,\
ctrl-q:execute-silent(echo {} | cut -d'|' -f1 | xargs pueue kill > /dev/null)+reload^$PUEUE_TASKS^,\
ctrl-l:execute(echo {} | cut -d'|' -f1 | xargs pueue log --full | bat -l log --style=rule,numbers --color=always --paging=always > /dev/tty),\
ctrl-t:execute(echo {} | cut -d'|' -f1 | xargs pueue follow | bat -l log --style=rule --color=always --paging=never > /dev/tty),\
ctrl-e:execute(echo {} | cut -d'|' -f1 | xargs pueue log --full | nvim -R),\
ctrl-f:reload^$PUEUE_TASKS^\
"

echo $PUEUE_TASKS | sh | fzf --header "${header}" -m --query "${PUEUE_GROUP:-default}" \
--preview="echo {} | cut -d'|' -f1 | xargs pueue log -l 57 | bat -l log --style=rule,numbers --color=always -r ':200'" \
--bind="$bind"
set +f
